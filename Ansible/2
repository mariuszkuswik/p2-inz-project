---
### DOCKER SWARM JOIN ###
- name: Docker Swarm - Sprawdz czy node jest czlonkiem clustra
  shell: "docker info | grep -v 'inactive' | grep '^.*Swarm.*active'"
  register: swarm_check_result
  ignore_errors: true

- name: Read file into variable
  ansible.builtin.slurp:
    path: '{{ nfs_rw_export_dirs[0] }}/token.txt'
  register: file_content_result
  become: yes
  become_user: root

- name: Display file content
  debug:
    var: file_content_result.content | b64decode

- name: Docker Swarm - dolaczenie do clustra
  command: "docker swarm join --token {{ file_content_result.content | b64decode }} {{ control_plane_ip }}:2377"
  register: swarm_init_result
  when: swarm_check_result is not defined or swarm_check_result.rc != 0

#- name: Docker Swarm - dolaczenie do clustra
#  command: "docker swarm join --token {{ lookup('ansible.builtin.file','{{ nfs_rw_export_dirs[0] }}/token.txt') }} {{ control_plane_ip }}:2377"
#  register: swarm_init_result
#  when: swarm_check_result is not defined or swarm_check_result.rc != 0
#  become: yes
#  become_user: root
