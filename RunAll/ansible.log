Sleep for 90 seconnds to let cloud-init finish

PLAY [Set up '{{ main_machine }}' host] ****************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.1.10]

TASK [common : Copy repository configuration files] ****************************
ok: [192.168.1.10] => (item=AppStream)
ok: [192.168.1.10] => (item=BaseOS)
ok: [192.168.1.10] => (item=Kubernetes)
ok: [192.168.1.10] => (item=docker-ce)
ok: [192.168.1.10] => (item=mongodb-org)

TASK [common : Install required packages] **************************************
ok: [192.168.1.10] => (item=python3.11)
changed: [192.168.1.10] => (item=docker-ce)
changed: [192.168.1.10] => (item=bash-completion)
ok: [192.168.1.10] => (item=containerd.io)
changed: [192.168.1.10] => (item=firewalld)
changed: [192.168.1.10] => (item=mongodb-mongosh)
changed: [192.168.1.10] => (item=jq)

TASK [common : Enable required services now and on boot] ***********************
changed: [192.168.1.10] => (item=firewalld)
changed: [192.168.1.10] => (item=docker)

TASK [common : Firewalld - Dodanie serwisów z listy] ***************************
changed: [192.168.1.10] => (item=nfs)

TASK [common : Firewalld - Dodanie portow tcp z listy] *************************
changed: [192.168.1.10] => (item=2377)
changed: [192.168.1.10] => (item=7946)
changed: [192.168.1.10] => (item=80)

TASK [common : Firewalld - Dodanie portow tcp z listy] *************************
changed: [192.168.1.10] => (item=7946)
changed: [192.168.1.10] => (item=4789)

TASK [common : Firewalld - Przeladowanie uslugi] *******************************
changed: [192.168.1.10]

TASK [common : SELinux - wylaczenie tymczasowe] ********************************
changed: [192.168.1.10]

TASK [common : SELinux - wylaczenie trwale] ************************************
changed: [192.168.1.10]

TASK [common : /etc/hosts - dodanie odpowiednich wpisow] ***********************
changed: [192.168.1.10]

TASK [nfs_server : Mounts - Ensure mount point exists] *************************
ok: [192.168.1.10] => (item=/mnt/repos)
ok: [192.168.1.10] => (item=/mnt/meta)
ok: [192.168.1.10] => (item=/mnt/ansible)

TASK [nfs_server : Mounts - Mount the optical drives] **************************
changed: [192.168.1.10] => (item=['/mnt/repos', '/dev/sr0'])
changed: [192.168.1.10] => (item=['/mnt/meta', '/dev/sr1'])
changed: [192.168.1.10] => (item=['/mnt/ansible', '/dev/sr2'])

TASK [nfs_server : NFS - Install server package] *******************************
ok: [192.168.1.10]

TASK [nfs_server : NFS - Start and enable] *************************************
changed: [192.168.1.10]

TASK [nfs_server : NFS - Ensure writable paths exists] *************************
changed: [192.168.1.10] => (item=/exports/control-plane)

TASK [nfs_server : Add NFS export entry to /etc/exports] ***********************
changed: [192.168.1.10] => (item=/mnt/repos)
changed: [192.168.1.10] => (item=/mnt/meta)
changed: [192.168.1.10] => (item=/mnt/ansible)
changed: [192.168.1.10] => (item=/exports/control-plane)

TASK [nfs_server : NFS - Restart nfs-server service] ***************************
changed: [192.168.1.10]

TASK [control_plane : Zmiana w configu containerd] *****************************
changed: [192.168.1.10]

TASK [control_plane : Restart uslugi containerd] *******************************
changed: [192.168.1.10]

TASK [control_plane : Wlaczenie uslugi containerd przy starcie systemu] ********
changed: [192.168.1.10]

TASK [control_plane : Docker Swarm - Check if node is part of Swarm] ***********
fatal: [192.168.1.10]: FAILED! => {"changed": true, "cmd": "docker info | grep -v 'inactive' | grep '^.*Swarm.*active'", "delta": "0:00:00.091242", "end": "2024-06-15 08:56:07.188191", "msg": "non-zero return code", "rc": 1, "start": "2024-06-15 08:56:07.096949", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring

TASK [control_plane : Docker Swarm - Initialization] ***************************
changed: [192.168.1.10]

TASK [control_plane : Docker Swarm - Node is already part of the cluster] ******
skipping: [192.168.1.10]

TASK [control_plane : Docker Swarm - Pobranie komendy pozwalajacej na dolaczenie do clustra] ***
changed: [192.168.1.10]

TASK [control_plane : Docker Swarm - Zapisanie tokena do pliku tekstowego] *****
changed: [192.168.1.10]

RUNNING HANDLER [nfs_server : Reload NFS server configuration] *****************
changed: [192.168.1.10]

PLAY [Set up node machines] ****************************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.1.201]
ok: [192.168.1.202]

TASK [nfs_client : Install NFS client package] *********************************
ok: [192.168.1.201]
ok: [192.168.1.202]

TASK [nfs_client : Ensure NFS read-only mount point exists] ********************
changed: [192.168.1.201] => (item=/mnt/repos)
changed: [192.168.1.202] => (item=/mnt/repos)
changed: [192.168.1.201] => (item=/mnt/meta)
changed: [192.168.1.202] => (item=/mnt/meta)
changed: [192.168.1.201] => (item=/mnt/ansible)
changed: [192.168.1.202] => (item=/mnt/ansible)

TASK [nfs_client : Ensure NFS writable mount point exists] *********************
changed: [192.168.1.201] => (item=/exports/control-plane)
changed: [192.168.1.202] => (item=/exports/control-plane)

TASK [nfs_client : Mount NFS read-only shares] *********************************
changed: [192.168.1.202] => (item=/mnt/repos)
changed: [192.168.1.201] => (item=/mnt/repos)
changed: [192.168.1.202] => (item=/mnt/meta)
changed: [192.168.1.201] => (item=/mnt/meta)
changed: [192.168.1.202] => (item=/mnt/ansible)
changed: [192.168.1.201] => (item=/mnt/ansible)

TASK [nfs_client : Mount NFS read-only shares] *********************************
changed: [192.168.1.201] => (item=/exports/control-plane)
changed: [192.168.1.202] => (item=/exports/control-plane)

TASK [nfs_client : Add entry to /etc/fstab] ************************************
ok: [192.168.1.201] => (item=/mnt/repos)
ok: [192.168.1.202] => (item=/mnt/repos)
ok: [192.168.1.201] => (item=/mnt/meta)
ok: [192.168.1.202] => (item=/mnt/meta)
ok: [192.168.1.201] => (item=/mnt/ansible)
ok: [192.168.1.202] => (item=/mnt/ansible)
changed: [192.168.1.201] => (item=/exports/control-plane)
changed: [192.168.1.202] => (item=/exports/control-plane)

TASK [common : Copy repository configuration files] ****************************
changed: [192.168.1.202] => (item=AppStream)
changed: [192.168.1.201] => (item=AppStream)
changed: [192.168.1.202] => (item=BaseOS)
changed: [192.168.1.201] => (item=BaseOS)
changed: [192.168.1.202] => (item=Kubernetes)
changed: [192.168.1.201] => (item=Kubernetes)
changed: [192.168.1.202] => (item=docker-ce)
changed: [192.168.1.201] => (item=docker-ce)
changed: [192.168.1.201] => (item=mongodb-org)
changed: [192.168.1.202] => (item=mongodb-org)

TASK [common : Install required packages] **************************************
changed: [192.168.1.201] => (item=docker-ce)
changed: [192.168.1.202] => (item=docker-ce)
changed: [192.168.1.201] => (item=bash-completion)
changed: [192.168.1.202] => (item=bash-completion)
ok: [192.168.1.201] => (item=containerd.io)
ok: [192.168.1.202] => (item=containerd.io)
changed: [192.168.1.202] => (item=iproute-tc)
changed: [192.168.1.201] => (item=iproute-tc)
changed: [192.168.1.201] => (item=firewalld)
changed: [192.168.1.202] => (item=firewalld)
changed: [192.168.1.201] => (item=mongodb-mongosh)
changed: [192.168.1.202] => (item=mongodb-mongosh)

TASK [common : Enable required services now and on boot] ***********************
changed: [192.168.1.201] => (item=docker)
changed: [192.168.1.202] => (item=docker)
changed: [192.168.1.201] => (item=firewalld)
changed: [192.168.1.202] => (item=firewalld)

TASK [common : Firewalld - Dodanie serwisów z listy] ***************************
skipping: [192.168.1.201]
skipping: [192.168.1.202]

TASK [common : Firewalld - Dodanie portow tcp z listy] *************************
changed: [192.168.1.201] => (item=2377)
changed: [192.168.1.202] => (item=2377)
changed: [192.168.1.201] => (item=7946)
changed: [192.168.1.202] => (item=7946)
changed: [192.168.1.201] => (item=80)
changed: [192.168.1.202] => (item=80)

TASK [common : Firewalld - Dodanie portow tcp z listy] *************************
changed: [192.168.1.201] => (item=7946)
changed: [192.168.1.202] => (item=7946)
changed: [192.168.1.201] => (item=4789)
changed: [192.168.1.202] => (item=4789)

TASK [common : Firewalld - Przeladowanie uslugi] *******************************
changed: [192.168.1.201]
changed: [192.168.1.202]

TASK [common : SELinux - wylaczenie tymczasowe] ********************************
changed: [192.168.1.201]
changed: [192.168.1.202]

TASK [common : SELinux - wylaczenie trwale] ************************************
changed: [192.168.1.201]
changed: [192.168.1.202]

TASK [common : /etc/hosts - dodanie odpowiednich wpisow] ***********************
changed: [192.168.1.201]
changed: [192.168.1.202]

TASK [node : Docker Swarm - Sprawdz czy node jest czlonkiem clustra] ***********
fatal: [192.168.1.201]: FAILED! => {"changed": true, "cmd": "docker info | grep -v 'inactive' | grep '^.*Swarm.*active'", "delta": "0:00:00.083807", "end": "2024-06-15 08:59:17.932484", "msg": "non-zero return code", "rc": 1, "start": "2024-06-15 08:59:17.848677", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [192.168.1.202]: FAILED! => {"changed": true, "cmd": "docker info | grep -v 'inactive' | grep '^.*Swarm.*active'", "delta": "0:00:00.085616", "end": "2024-06-15 08:59:17.958048", "msg": "non-zero return code", "rc": 1, "start": "2024-06-15 08:59:17.872432", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring

TASK [node : Read file into variable] ******************************************
ok: [192.168.1.202]
ok: [192.168.1.201]

TASK [node : Display decoded file content] *************************************
ok: [192.168.1.201]
ok: [192.168.1.202]

TASK [node : Save decoded file content to a variable] **************************
ok: [192.168.1.201]
ok: [192.168.1.202]

TASK [node : Docker Swarm - dolaczenie do clustra] *****************************
changed: [192.168.1.201]
changed: [192.168.1.202]

PLAY [Reboot] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.1.202]
ok: [192.168.1.201]

TASK [Reboot] ******************************************************************
changed: [192.168.1.202]
changed: [192.168.1.201]

PLAY [Set up docker swarm service] *********************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.1.10]

TASK [mongo_swarm : Create mongo_replica_set service stack] ********************
changed: [192.168.1.10]

TASK [mongo_swarm : Przeskalowanie uslugi mongo_control-plane do 0] ************
changed: [192.168.1.10]

TASK [mongo_swarm : Przeskalowanie uslugi mongo_control-plane do 1] ************
changed: [192.168.1.10]

TASK [Scale mongo] *************************************************************
changed: [192.168.1.10]

TASK [Scale mongo] *************************************************************
changed: [192.168.1.10]

PLAY [Set up docker swarm replica set] *****************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.1.201]

TASK [mongo_replica_set : Check if MongoDB replica set is configured] **********
fatal: [192.168.1.201]: FAILED! => {"changed": true, "cmd": ["mongosh", "--host", "192.168.1.10:27017", "--quiet", "--eval", "rs.status().ok"], "delta": "0:00:00.607236", "end": "2024-06-15 09:01:04.883069", "msg": "non-zero return code", "rc": 1, "start": "2024-06-15 09:01:04.275833", "stderr": "MongoServerError: no replset config has been received", "stderr_lines": ["MongoServerError: no replset config has been received"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [mongo_replica_set : Debug Replica Set Check Result] **********************
ok: [192.168.1.201] => {
    "msg": "Replica set check result: "
}

TASK [mongo_replica_set : Initialize MongoDB Replica Set] **********************
changed: [192.168.1.201]

TASK [mongo_replica_set : Run mongosh to get replica set state] ****************
changed: [192.168.1.201]

TASK [mongo_replica_set : Extract syncingTo value using shell command] *********
changed: [192.168.1.201]

TASK [mongo_replica_set : Debug primary name] **********************************
ok: [192.168.1.201] => {
    "msg": "Primary name: "
}

TASK [mongo_replica_set : Create database] *************************************
fatal: [192.168.1.201]: FAILED! => {"changed": true, "cmd": ["mongosh", "--host", "", "mydatabase", "--eval", " db.createCollection(\"mycollection\"); db.mycollection.insertMany([\n  { name: \"Alice\", age: 30 },\n  { name: \"Bob\", age: 25 },\n  { name: \"Charlie\", age: 35 }\n]); "], "delta": "0:00:00.498059", "end": "2024-06-15 09:01:08.457962", "msg": "non-zero return code", "rc": 1, "start": "2024-06-15 09:01:07.959903", "stderr": "MongoServerError: not master", "stderr_lines": ["MongoServerError: not master"], "stdout": "", "stdout_lines": []}

NO MORE HOSTS LEFT *************************************************************

PLAY RECAP *********************************************************************
192.168.1.10               : ok=32   changed=27   unreachable=0    failed=0    skipped=1    rescued=0    ignored=1   
192.168.1.201              : ok=30   changed=21   unreachable=0    failed=1    skipped=1    rescued=0    ignored=2   
192.168.1.202              : ok=23   changed=17   unreachable=0    failed=0    skipped=1    rescued=0    ignored=1   

Command failed. Retrying in 5 seconds...
Reached the total duration of 380 seconds. Exiting.
